---
title: "Yet Another Log4j Inspired Logging Framework"
author: "Stefan Fleck"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{yog}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(yog)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

Yog is a logging framework for R inspired by 
[Apache Log4j](https://logging.apache.org/log4j/2.x/) and
[Python logging](https://docs.python.org/3/library/logging.html).
It is based on [R6 classes](https://github.com/r-lib/R6) that 
focuses on extensibility, ease of use, and performance

## Quickstart

Configure a new logger that writes all log messages of level *info* or more to 
a text file and of level *error* or more to a json file.

**Setup:**
```{r}
tfi <- tempfile(fileext = ".info")
tfe <- tempfile(fileext = ".error")
l <- Logger$new(
  "example Logger",
  appenders = list(
    AppenderFile$new(tfi, threshold = "info"),
    AppenderFile$new(tfe, threshold = "error", layout = LayoutJson$new())
  )
)

```

**Usage:**
```{r}
l$info("Everything is okay")
l$error("Everything is NOT okay")
l$fatal("NOTHING is okay")
readLines(tfi)
read_json_lines(tfe)
file.remove(tfi, tfe)

```
  



# Usage

## Structure of the Logging System

If you want custom logging configurations, you have to understand the structure
of the logging process.

* A **Logger** collects information and dispatches it to its *Appenders*, and
  also the *Appenders* of its *Parent Loggers* (also see the section on 
  hierarchical logging)
* An **Appender** writes the log message to destination (the console, a file, 
  a database, etc...).
* A **Layout** is used by an Appender to format LogRecords. For example,
  `AppenderFile` uses `LayoutFormat` by default to write human readable log
  events to a text file, but can also use `LayoutJson` produce machine 
  readable JSON lines logfiles.
* **LogEvents** are produced by the Logger and dispatched to Appenders. They 
  contain all the information that is beeing logged (think of
  it as a row in table). LogEvents usually contain the log level, a timestamp,
  a message, the name of the calling function, and a 
  [reference](https://adv-r.hadley.nz/r6.html#r6-semantics]) to the Logger
  that created it. In addition, a LogEvent can contain any number of custom
  fields, but not all Appenders/Layouts support custom fields. For example
  if you use `AppenderFormat` with `LayoutFormat` you can only use the standard 
  fields in your log message, while `LayoutJson` supports custom fields in 
  a quite natural manner. See [examples 1 & 2](#examples)



## Log Levels

Yog supports the standard log4j Log Levels outlined bellow. The Log Level of
an event represents its severity. Log levels have numeric and character 
representations. Creation of custom log levels ist not yet supported by yog 
(but planned for the future).

```{r, echo = FALSE}
ll <- data.frame(
  `Level` = c(0, seq(100, 600, by = 100), NA),
  `Name` = c("off", "fatal", "error", "warn", "info", "debug", "trace", "all"),
  `Description` = c(
    "A log level of 0/off tells a Logger or Appender to suspend all logging",
    "Critical error that leads to program abort. Should always indicate a `stop()` or similar",
    "A severe error that does not trigger program abort",
    "A potentially harmful situation, like `warning()`",
    "An informatinal message on the progress of the application",
    "Finer grained informational messages that are mostly useful for debugging",
    "An even finer grained message than debug",
    "A log level of NA/all tells a Logger or Appender to process all log events"
  )
) 

knitr::kable(ll)
```



## Simple Logging With the Root Logger

Yog comes with a pre-configured Root Logger. If you do not care about 
using multiple loggers, and do not want to deal with R6 classes you still use 
yog as a performant and easy to use logging solution.

```{r}
FATAL("This is an important message about %s going wrong", "something")
ERROR("A less severe error")
WARN("something likely went wrong")
INFO("Everything is ok")
DEBUG("Debug messages are hidden by default")
console_threshold("debug")  # you must use lower case names here
DEBUG("unless we lower the threshold")
TRACE("Trace is even lower than debug")

```

You can also directly use Logger R6 objects to log. This package comes with a
default root logger named like the package (`"yog"`). This method of referring
to the logger is more explicit (and therefore arguably better). The examples
in this vignette will moslty use the notation below.

```{r}
yog$fatal("This is an important message about %s going wrong", "->something<-")
yog$trace("Trace messages are still hidden")
yog$appenders$console$set_threshold("trace")
yog$trace("Unless we lower the threshold")
```


## Thresholds: Controlling Output Detail

(wip)



## Appenders: Managing Log Destinations

The root logger only logs to the console by default. If you want to redirect 
the output to a file you can just add a file appender to yog.

```{r}
tf <- tempfile()

# Add a new appender to a logger. We don't have to supply a name, but that
# makes it easier to remove later.
yog$add_appender(AppenderFile$new(file = tf), name = "file")

# configure yog so that it logs everything to the file, but only info and above
# to the console
yog$set_threshold(NA)
yog$appenders$console$set_threshold("info")
yog$appenders$file$set_threshold(NA)
yog$info("Another informational message")
yog$debug("A debug message not shown by the console appender")

readLines(tf)

# Remove the appender again
yog$remove_appender("file")
```



## Inheritance: Hierarchical Loggers

Each newly created Logger is child to a parent Logger. If no parent Logger
is specified manually during a Logger's creation, its parent is the Root 
Logger. A logger dispatches the LogRecords it creates not only to its own
Appenders, but also to the Appenders of all its ancestral Appenders (ignoring
the threshold and Filters of the ancestral Loggers, but not of the ancestral 
Appenders).


![](log_flow.svg)


# Examples {#examples}

## Logging to the console 

yog comes with simple formatting syntax. The configuration possibilites are 
limited, but should be sufficient for most users.

```{r}
lg <- Logger$new(
  "test", 
  appenders = list(cons = AppenderConsole$new()), 
  propagate = FALSE
)

lg$info("the default format")

lg$appenders$cons$layout$set_fmt("%L (%n) [%t] %c(): !! %m !!")
lg$info("A more involved custom format")
```

More complex formats are possible with `LayoutGlue` powered by the awesome
[glue](https://github.com/tidyverse/glue) package, at the cost of slightly
worse performance.
```{r}
# install.packages("glue")

# WIP
```



## Logging to JSON files

JavaScript Object Notation (JSON) is an open-standard file format that uses 
human-readable text to transmit data objects consisting of attributeâ€“value 
pairs and array data types ([wikipedia](https://en.wikipedia.org/wiki/JSON)).
JSON is the **recommended text-based logging format when logging to files**
  ^[Technically, the logger does not produce standard JSON files but 
  [JSON lines](http://jsonlines.org/)], 
as it is human- as well as machine readable. You should only log to a different 
format if you have very good reasons for it. 


```{r}
# install.packages("jsonlite")
tf <- tempfile()

# AppenderJson is just a shortcut for AppenderFile with LayotJson as default
# instead of Layout Format
lg <- Logger$new(
  "test logger",
  appenders = AppenderJson$new(file = tf), 
  propagate = FALSE
)

lg$info("JSON naturally supports custom log fields", field = "custom")
lg$info("You can serialize most R data types to JSON", numbers = 1:5)
lg$info("If you ever want to analyse your log files", use = "JSON")

```

JSON is easy to parse and analyse with R
```{r}
read_json_lines(tf)
```

It is also human readable, though maybe this vignett does not 
transport that fact very well because of the lack of horizontal space
```{r}
cat(readLines(tf), sep = "\n\n")
```

```{r, echo = FALSE}
unlink(tf)
```


