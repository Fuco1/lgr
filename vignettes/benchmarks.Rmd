---
title: "benchmarks"
author: "Stefan Fleck"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(devtools)
library(bench)
library(dplyr)
library(lgr)

```

```{r}
ITS <- seq_len(1e2)
```


# Setup loggers
```{r}
app <- list(
  disabled = AppenderFile$new(tempfile()),
  plain    = AppenderFile$new(tempfile()),
  rotating = AppenderFileRotating$new(tempfile()),
  rotating_date = AppenderFileRotatingDate$new(tempfile()),
  json     = AppenderJson$new(tempfile())
)

# configure AppenderRotatingDate so that it is forced to 
# check the date stamp on each log (the wors-case scenario)
td <- list()
td$rotating      <- file.path(tempdir(), "rotating")
td$rotating_date <- file.path(tempdir(), "rotating_date")
lapply(td, dir.create)

# set backup dirs so that they don't conflict
app$rotating$
  set_backup_dir(td$rotating)

app$rotating_date$
  set_size(-1)$
  set_age("1 year")$
  set_backup_dir(td$rotating_date)

app$rotating$rotate()
app$rotating_date$rotate()
app$rotating_date$rotate()
stopifnot(nrow(app$rotating_date$backups) == 1)
stopifnot(nrow(app$rotating$backups) == 0)

loggers = list(
  disabled = get_logger("disabled")$set_propagate(FALSE)$add_appender(app$disabled)$set_threshold(0),
  plain = get_logger("plain")$set_propagate(FALSE)$add_appender(app$plain),
  rotating = get_logger("rotating")$set_propagate(FALSE)$add_appender(app$rotating),
  rotating_date = get_logger("rotating_date")$set_propagate(FALSE)$add_appender(app$rotating_date),
  json = get_logger("json")$set_propagate(FALSE)$add_appender(app$json)
)


loggers$rotating$info("test")
loggers$rotating$info("test")
loggers$rotating_date$info("test")
loggers$rotating_date$info("test")

```

```{r}
exprs <- lapply(
  loggers,
  function(.x) bquote(for (i in ITS) .(.x)$fatal("a test message"))
)

```

```{r}
res <- mark(exprs = exprs, iterations = 100)


res %>% 
  dplyr::transmute(
    expression = format(expression), 
    median = format(median), 
    mem_alloc = format(mem_alloc)
  ) %>% 
  knitr::kable()

```
```{r}
plot(res)
```



```{r}
# length(readLines(app$disabled$file)) == 0
# length(readLines(app$plain$file)) == length(ITS)
# length(readLines(app$json$file)) == length(ITS)
# length(readLines(app$rotating$file)) == length(ITS)

lapply(app, function(a) unlink(a$file))
lapply(td,  function(d) unlink(d, recursive = TRUE))

```

